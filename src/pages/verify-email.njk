---
layout: base.njk
title: "Verify Email"
description: "Confirm your email address to activate your TGK membership."
glyph: "☥"
glyphRow: ["☥", "✶", "☥"]
bodyClass: "lightgold"
permalink: "/verify-email/index.html"

# === Unified Header Hierarchy ===
siteTitle: "The Gnostic Key"
pillarTitle: "Membership"
gateTitle: "Verification"
seriesTitle: null
seasonTitle: null
episodeTitle: "Verify Email"
partTitle: null

breadcrumbs:
  - { title: "The Gnostic Key", url: "/" }
  - { title: "Membership", url: "/membership/" }
  - { title: "Dashboard", url: "/dashboard/" }
  - { title: "Verify Email" }
---

<main class="main-content">
  <section class="content-container">

    <div class="auth-glyph-wrap">
      <div class="auth-glyph glow">✶</div>
    </div>

    <section class="section-block auth-form">
      <h2 class="section-heading">Confirm Your Email</h2>
      <p class="lead muted">We are verifying your address, please hold the light...</p>

      <div id="verify-msg" class="auth-feedback" role="alert"></div>
    </section>

  </section>

  <div class="gnostic-divider">
    <span class="divider-symbol pillar-glyph spin glow">{{ glyph }}</span>
  </div>
</main>

{% raw %}
<script type="module">
  import {
    getAuth,
    applyActionCode
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  import { app } from "/js/firebase-init.js";
  import { consumeReturnUrl } from "/js/tgk-gate.js";

  const auth = getAuth(app);
  const msg = document.getElementById("verify-msg");
  const params = new URLSearchParams(window.location.search);
  const oobCode = params.get("oobCode");
  const fallbackReturn = params.get("return");
  const verifyChannel = new BroadcastChannel("tgk-email-verify");

  async function syncEntitlements(user) {
    try {
      const token = await user.getIdToken(true);

      await fetch("/.netlify/functions/set-entitlements", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, uid: user.uid, email: user.email })
      });

      console.log("[Verify] Claims and entitlements refreshed.");
    } catch (err) {
      console.error("[Verify] Sync failed:", err);
    }
  }

  async function verify() {
    msg.textContent = "Verifying…";

    try {
      await applyActionCode(auth, oobCode);

      msg.innerHTML = `
        <strong>Email verified successfully!</strong><br>
        Preparing your account…
      `;

      await auth.currentUser.reload();

      await syncEntitlements(auth.currentUser);

      verifyChannel.postMessage({ verified: true });

      setTimeout(() => {
        if (consumeReturnUrl()) return;
        if (fallbackReturn) return window.location.replace(fallbackReturn);
        window.location.replace("/dashboard/");
      }, 1000);

    } catch (err) {
      console.error("[Verify] Error:", err);
      msg.innerHTML = "Verification link invalid or expired.";
    }
  }

  if (oobCode) verify();
  else msg.textContent = "Invalid verification link.";
</script>
{% endraw %}



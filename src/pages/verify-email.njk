---
layout: base.njk
title: "Verify Email"
description: "Confirm your email address to activate your TGK membership."
glyph: "☥"
glyphRow: ["☥", "✶", "☥"]
bodyClass: "lightgold"
permalink: "/verify-email/index.html"

siteTitle: "The Gnostic Key"
pillarTitle: "Membership"
gateTitle: "Verification"
episodeTitle: "Verify Email"

breadcrumbs:
  - { title: "The Gnostic Key", url: "/" }
  - { title: "Membership", url: "/membership/" }
  - { title: "Dashboard", url: "/dashboard/" }
  - { title: "Verify Email" }
---

<main class="main-content">
  <section class="content-container">

    <div class="auth-glyph-wrap">
      <div class="auth-glyph glow">✶</div>
    </div>

    <section class="section-block auth-form">
      <h2 class="section-heading">Confirm Your Email</h2>
      <p class="lead muted">We are verifying your address, please hold the light...</p>

      <div id="verify-msg" class="auth-feedback" role="alert"></div>
    </section>

  </section>

  <div class="gnostic-divider">
    <span class="divider-symbol pillar-glyph spin glow">{{ glyph }}</span>
  </div>
</main>

{% raw %}
<script type="module">
  import { getAuth, applyActionCode } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { app } from "/js/firebase-init.js";
  import { consumeReturnUrl } from "/js/tgk-gate.js";

  const auth = getAuth(app);
  const msg = document.getElementById("verify-msg");

  const params = new URLSearchParams(window.location.search);
  const oobCode = params.get("oobCode");
  const fallbackReturn = params.get("return");

  const channel = new BroadcastChannel("tgk-email-verify");

  async function verify() {
    msg.textContent = "Verifying your address...";

    try {
      await applyActionCode(auth, oobCode);

      msg.innerHTML = `
        <strong>Email verified successfully!</strong><br>
        Redirecting you now…
      `;

      await auth.currentUser?.reload();
      await auth.currentUser?.getIdToken(true);

      // Notify all other tabs immediately
      channel.postMessage({ verified: true });

      setTimeout(() => {
        if (consumeReturnUrl()) return;
        if (fallbackReturn) return window.location.replace(fallbackReturn);
        window.location.replace("/dashboard/");
      }, 1200);

    } catch (error) {
      console.error("[Verify] Error:", error);
      msg.innerHTML = "Verification link invalid or expired. Please request a new one from your dashboard.";
    }
  }

  if (oobCode) verify();
  else msg.textContent = "Invalid verification link.";
</script>
{% endraw %}

---
layout: base.njk
title: "Your TGK Dashboard"
description: "Manage your profile, tier, and sacred bookmarks."
glyph: "ðŸœ‚"
glyphRow: ["ðŸœ‚", "â˜¥", "ðŸœ‚"]
bodyClass: "lightgold requires-auth"
permalink: "/dashboard/index.html"

breadcrumbs:
  - { title: "The Gnostic Key", url: "/" }
  - { title: "Dashboard" }
---

{% block head %}
  {% set socialImage = "/tgk-assets/images/share/system/dashboard.jpg" %}
  {% include "partials/head-meta.njk" %}
  {% set headline = "Dashboard â€” The Gnostic Key" %}
  {% set base = "/dashboard/" %}
  {% include "partials/jsonld-collection.njk" %}
{% endblock %}

<main class="main-content page-dashboard">
  <section class="content-container" id="page-dashboard">

    <!-- âœ¦ Profile + Tier -->
    <section class="section-block">
      <h2 class="section-heading">Welcome, <span id="user-name">Seeker</span></h2>
      <p>Your current tier: <strong id="user-tier">Loadingâ€¦</strong></p>

      <div class="btn-wrap">
        <button id="manage-tier" class="btn outline">Manage Membership</button>
        <button id="logout-btn" class="btn outline">Logout</button>
      </div>
    </section>

    <!-- âœ¦ Upgrade CTA -->
    <section id="upgrade-cta" class="section-block dashboard-upgrade" hidden>
      <h3>Unlock Deeper pages</h3>
      <p>Upgrade your access to reveal all Vault texts and advanced series.</p>
      <a href="/membership/" class="btn gold">Upgrade Membership</a>
    </section>

    <!-- âœ¦ Bookmarks -->
    <section class="section-block">
      <h2 class="section-heading">Your Bookmarks</h2>

      <ul id="bookmark-list" class="dashboard-bookmarks">
        <li class="dashboard-card">
          <div class="card-body muted">Loading bookmarksâ€¦</div>
        </li>
      </ul>

      <p id="no-bookmarks" class="muted small" hidden>
        No bookmarks yet. Explore the <a href="/pillars/the-teachings/">Teachings</a> or
        the <a href="/pillars/the-vault/">Vault</a> to begin your journey.
      </p>
    </section>

  </section>

  <!-- âœ¦ Divider -->
  <div class="gnostic-divider">
    <span class="divider-symbol pillar-glyph spin glow" aria-hidden="true">{{ glyph }}</span>
  </div>
</main>

<!-- =========================================================
     ðŸœ‚ Dashboard Script â€” Tier + Bookmarks + Stripe Portal
   ========================================================= -->
<script type="module">
import {
  getAuth,
  onAuthStateChanged,
  getIdTokenResult,
  signOut
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { app } from "/js/firebase-init.js";
import { toggleBookmark } from "/js/bookmarks.js";

const auth = getAuth(app);
const db = getFirestore(app);

const bookmarkList = document.getElementById("bookmark-list");
const noBookmarks = document.getElementById("no-bookmarks");
const upgradeCTA = document.getElementById("upgrade-cta");

/* ===========================================================
   ðŸœ‚ Resolve User Tier Hierarchy
   =========================================================== */
async function resolveUserTier(user) {
  let tier = "free";
  try {
    const token = await getIdTokenResult(user);
    if (token?.claims?.tier) tier = token.claims.tier;
    else {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (snap.exists() && snap.data().tier) tier = snap.data().tier;
    }
    const cached = localStorage.getItem("tgk-tier");
    if (cached) tier = cached;
    localStorage.setItem("tgk-tier", tier);
  } catch (err) {
    console.warn("[TGK] Tier resolve error:", err);
  }
  return tier;
}

/* ===========================================================
   ðŸœ‚ Helper â€” Build Clean Title
   =========================================================== */
function formatTitleFromId(pageId) {
  return pageId
    .split("-")
    .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
    .join(" ");
}

/* ===========================================================
   ðŸœ‚ Helper â€” Build Href from page ID
   =========================================================== */
function buildHrefFromId(pageId) {
  // Detect multi-part pages
  if (pageId.includes("part-")) {
    const parts = pageId.split("-");
    const idx = parts.indexOf("part");
    const prefix = parts.slice(0, idx).join("/");
    const suffix = parts.slice(idx, idx + 2).join("-");
    return `/pillars/${prefix}/${suffix}/`;
  }

  // Normal page
  return `/pillars/${pageId.replace(/-/g, "/")}/`;
}

/* ===========================================================
   ðŸœ‚ Main Dashboard Loader
   =========================================================== */
onAuthStateChanged(auth, async (user) => {
  if (!user) return;

  document.getElementById("user-name").textContent =
    user.displayName || user.email.split("@")[0];

  let tier = await resolveUserTier(user);

  // ðŸœ‚ Force-admin fallback for The Keymaker
  if (user.email === "the.keymaker@thegnostickey.com") {
    tier = "admin";
    localStorage.setItem("tgk-tier", "admin");
    console.log("[TGK Dashboard] ðŸœ‚ Forced admin tier for Keymaker account");
  }

  document.getElementById("user-tier").textContent = tier.toUpperCase();

  if (["free", "initiate"].includes(tier)) upgradeCTA.hidden = false;

  /* ===========================================================
     ðŸ”– Load Bookmarks with Smart Hrefs
     =========================================================== */
  try {
    const snap = await getDocs(collection(db, "bookmarks", user.uid, "pages"));
    bookmarkList.innerHTML = "";

    if (snap.empty) {
      noBookmarks.hidden = false;
      return;
    }

    snap.forEach((docSnap) => {
      const pageId = docSnap.id;
      const href = buildHrefFromId(pageId);
      const title = formatTitleFromId(pageId);

      const item = document.createElement("li");
      item.className = "dashboard-card";
      item.dataset.id = pageId;
      item.innerHTML = `
        <div class="card-body">
          <a href="${href}" class="card-link">
            <h3 class="card-title">${title}</h3>
          </a>
          <button class="btn-mini" data-id="${pageId}">Remove</button>
        </div>`;
      bookmarkList.appendChild(item);
    });

    // ðŸ”¹ Bind remove buttons
    bookmarkList.querySelectorAll(".btn-mini").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        const id = e.target.dataset.id;
        if (!confirm("Remove bookmark?")) return;

        const card = e.target.closest(".dashboard-card");
        if (card) card.classList.add("removing");
        await toggleBookmark(id, null);
        await new Promise((res) => setTimeout(res, 400));
        card?.remove();

        if (!bookmarkList.children.length) noBookmarks.hidden = false;
      });
    });
  } catch (err) {
    console.error("[Dashboard] Bookmark load error:", err);
    noBookmarks.hidden = false;
  }
});

/* ===========================================================
   ðŸœ‚ Stripe Portal Access
   =========================================================== */
document.getElementById("manage-tier").onclick = async () => {
  const user = auth.currentUser;
  const email = user?.email || prompt("Enter your Stripe email:");
  const res = await fetch("/.netlify/functions/create-portal-session", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email })
  });
  const data = await res.json();
  if (data.url) window.location = data.url;
  else alert(data.error || "Portal error");
};

/* ===========================================================
   ðŸšª TGK â€” Unified Logout Redirect
   =========================================================== */
document.addEventListener("DOMContentLoaded", () => {
  const logoutBtn = document.getElementById("logout-btn");
  if (logoutBtn) {
    logoutBtn.addEventListener("click", (e) => {
      e.preventDefault();
      console.log("[TGK Dashboard] Redirecting to /logout/");
      window.location.href = "/logout/";
    });
  }
});

</script>

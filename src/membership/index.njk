---
layout: base.njk
title: "Your TGK Membership"
description: "Join, manage, or upgrade your access. Support sacred knowledge preservation and unlock deeper pages of The Gnostic Key."
glyph: "ðŸœ‚"
glyphRow: ["ðŸœ‚", "â˜¥", "ðŸœ‚"]
bodyClass: "lightgold requires-auth"
permalink: "/membership/index.html"

# === Unified Header Hierarchy ===
siteTitle: "The Gnostic Key"
pillarTitle: "Membership"
gateTitle: "Membership Centre"
seriesTitle: null
seasonTitle: null
episodeTitle: "Membership"
partTitle: null

breadcrumbs:
  - { title: "The Gnostic Key", url: "/" }
  - { title: "Dashboard", url: "/dashboard/" }
  - { title: "Membership" }
---

{% block head %}
  {% set socialImage = "/tgk-assets/images/share/system/membership.jpg" %}
  {% include "partials/head-meta.njk" %}
  {% set headline = "Membership â€” The Gnostic Key" %}
  {% set base = "/membership/" %}
  {% include "partials/jsonld-collection.njk" %}
{% endblock %}

<main class="main-content">
  <section class="content-container" id="page-membership">

    <div class="dashboard-welcome">
      <h2 class="section-heading">
        Welcome, <span id="user-name" class="highlight">Seeker</span>
      </h2>
    </div>

    <!-- Current Tier Summary -->
    <div class="tier-display inline">
      <span>Your current tier:</span>
      <span id="tier-badge" class="tier-badge tier-free">Free</span>
      <span class="member-since muted"><span id="member-since">â€”</span></span>
    </div>

    <!-- Membership and Billing -->
    <section class="section-block">
      <h3 class="section-heading">Membership and Billing</h3>

      <div class="btn-wrap membership-buttons center">
        <button id="manage-btn" class="btn gold">Open Billing Portal</button>
      </div>

      <p class="small muted">
        Manage your payment methods, view invoices, update your tier, or cancel your plan at any time through Stripeâ€™s secure customer portal.
      </p>
    </section>

    <!-- Join Options -->
    <section class="section-block join-options">
      <h3 class="section-heading">Choose Your Path</h3>

      <p class="lead">
        The Gnostic Key is sustained by its readers.  
        Select a tier of membership to unlock deeper archives, support future investigations,  
        and take your place within our circle of initiates.
      </p>

      {% include "partials/page-membership-grid.njk" %}
    </section>

    <!-- FAQ -->
    <section class="section-block">
      <h3 class="section-heading">Frequently Asked Questions</h3>

      <details>
        <summary>Can I change my tier later?</summary>
        <p>You may upgrade, downgrade, or cancel at any time through your dashboard.</p>
      </details>

      <details>
        <summary>Do I need an account to access free pages?</summary>
        <p>Free content is publicly available. However, creating an account allows you to save bookmarks and access future community features.</p>
      </details>

      <details>
        <summary>How secure is my payment?</summary>
        <p>All billing is conducted through Stripe. The Gnostic Key never stores card details or sensitive financial information.</p>
      </details>
    </section>

    <!-- Logout -->
    <section class="section-block">
      <h3 class="section-heading">Sign Out</h3>
      <p class="small">You may securely sign out of your account below.</p>

      <div class="btn-wrap center">
        <button id="logout-btn" class="btn outline">Sign Out</button>
      </div>
    </section>

  </section>

  <div class="gnostic-divider">
    <span class="divider-symbol pillar-glyph spin glow" aria-hidden="true">{{ glyph }}</span>
  </div>
</main>

<!-- Unified Membership Logic -->
<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import {
    loadDashboardHeader,
    pageSignout,
    updateTierUI,
    refreshEntitlementsLive
  } from "/js/tgk-user.js";

  const auth = getAuth();

  document.addEventListener("DOMContentLoaded", () => {
    // Load cached tier instantly
    const cachedTier = localStorage.getItem("tgk-tier");
    if (cachedTier) updateTierUI(cachedTier);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        await loadDashboardHeader(user);
        await refreshEntitlementsLive(user);
        document.getElementById("logout-btn")?.addEventListener("click", pageSignout);
      } else {
        updateTierUI("visitor");

        // Preserve intended destination
        window.__TGK_GATE__?.saveReturnUrl?.();

        if (!location.pathname.includes("/signin")) {
          window.location.replace("/signin/");
        }
      }
    });
  });

  // Manage Billing Portal
  const manageBtn = document.getElementById("manage-btn");

  manageBtn?.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) {
      alert("Please sign in to manage billing.");
      return;
    }

    try {
      const token = await user.getIdToken();

      const res = await fetch("/.netlify/functions/create-portal-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, email: user.email })
      });

      const data = await res.json();

      if (res.ok && data.url) {
        console.log("[TGK] Redirecting to Stripe portal");
        window.location.href = data.url;
      } else {
        console.warn("[TGK] Portal error:", data);
        alert("The billing portal could not be opened. Please try again shortly.");
      }
    } catch (err) {
      console.error("[TGK] Portal session error:", err);
      alert("An error occurred whilst opening the billing portal.");
    }
  });
</script>

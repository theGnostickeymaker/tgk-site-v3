---
layout: base.njk
title: "Your TGK Membership"
description: "Join, manage, or upgrade your access â€” support sacred knowledge preservation and unlock deeper pages of The Gnostic Key."
glyph: "ðŸœ‚"
glyphRow: ["ðŸœ‚", "â˜¥", "ðŸœ‚"]
bodyClass: "lightgold requires-auth"
permalink: "/membership/index.html"

breadcrumbs:
  - { title: "The Gnostic Key", url: "/" }
  - { title: "Dashboard",  url: "/dashboard/"}
  - { title: "Membership" }
---

{% block head %}
  {% set socialImage = "/tgk-assets/images/share/system/membership.jpg" %}
  {% include "partials/head-meta.njk" %}
  {% set headline = "Membership â€” The Gnostic Key" %}
  {% set base = "/membership/" %}
  {% include "partials/jsonld-collection.njk" %}
{% endblock %}

<main class="main-content page-membership">
  <section class="content-container" id="page-membership">

    <!-- âœ¦ Welcome -->
    <div class="tier-display inline">
      <span>Your current tier:</span>
      <span id="tier-badge" class="tier-badge tier-free">Free</span>
      <span class="tier-divider"></span>
      <span class="member-since muted">Member since: <span id="member-since">â€”</span></span>
    </div>

    <!-- âœ¦ Membership & Billing -->
    <section class="section-block">
    <h3 class="section-heading">Membership & Billing</h3>
    <div class="btn-wrap membership-buttons">
      <button
        id="upgrade-btn"
        class="btn outline"
        data-price="price_INITIATE_ID">
        Upgrade / Join via Stripe
      </button>

      <button id="manage-btn" class="btn outline">
        Manage Billing Portal
      </button>
    </div>
    <p class="small">
      You can upgrade, downgrade, or cancel your plan at any time through the secure Stripe portal.
    </p>
    </section>

    <!-- âœ¦ Join Section (for visitors or free users) -->
    <section class="section-block join-options">
      <h3 class="section-heading">Choose Your Path</h3>
      <p class="lead">
        The Gnostic Key is sustained by seekers like you.<br>
        Choose your tier of membership to unlock deeper archives,<br>
        support future pages, and join our growing circle of initiates.
      </p>

      {% include "partials/page-membership-grid.njk" %}
    </section>

    <!-- âœ¦ FAQ -->
    <section class="section-block">
      <h3 class="section-heading">Frequently Asked Questions</h3>
      <details>
        <summary>Can I change my tier later?</summary>
        <p>Yes â€” you can upgrade, downgrade, or cancel anytime through your Dashboard.</p>
      </details>
      <details>
        <summary>Do I need an account to access free pages?</summary>
        <p>No â€” free-tier pages are open to all visitors, but an account allows you to save bookmarks and join discussions.</p>
      </details>
      <details>
        <summary>How secure is my payment?</summary>
        <p>All payments are handled via Stripe â€” TGK never stores your card details or sensitive financial data.</p>
      </details>
    </section>

    <!-- âœ¦ Logout -->
    <section class="section-block">
      <h3 class="section-heading">Sign Out</h3>
      <p class="small">You can securely sign out of your TGK account below.</p>

      <div class="btn-wrap center">
        <button id="logout-btn" class="btn outline">Sign Out</button>
      </div>
    </section>

  </section>

  <div class="gnostic-divider">
    <span class="divider-symbol pillar-glyph spin glow" aria-hidden="true">{{ glyph }}</span>
  </div>
</main>

<!-- ðŸœ‚ Unified Membership Logic -->
<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { loadDashboardHeader, pageSignout, updateTierUI, refreshEntitlementsLive } from "/js/tgk-user.js";

  const auth = getAuth();

  document.addEventListener("DOMContentLoaded", () => {
    const cachedTier = localStorage.getItem("tgk-tier");
    if (cachedTier) updateTierUI(cachedTier);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        await loadDashboardHeader(user);
        await refreshEntitlementsLive(user);
        document.getElementById("logout-btn")?.addEventListener("click", pageSignout);
      } else {
        updateTierUI("visitor");
        window.__TGK_GATE__?.saveReturnUrl?.();
        if (!location.pathname.includes("/signin")) {
          window.location.replace("/signin/");
        }
      }
    });
  });

  // ðŸœ‚ Upgrade Button
  import { getAuth as getAuth2 } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  const auth2 = getAuth2();
  const upgradeBtn = document.getElementById("upgrade-btn");
  if (upgradeBtn) {
    upgradeBtn.addEventListener("click", async () => {
      const user = auth2.currentUser;
      if (!user) {
        alert("Please sign in before upgrading.");
        window.location.href = "/signin/";
        return;
      }
      try {
        const token = await user.getIdToken();
        const priceId = upgradeBtn.dataset.price;
        const res = await fetch("/.netlify/functions/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            priceId,
            uid: user.uid,
            email: user.email,
            returnUrl: window.location.origin + "/membership/"
          })
        });
        const data = await res.json();
        if (!res.ok || !data.sessionId) throw new Error(data.error || "Stripe session error");
        const stripe = Stripe(window.STRIPE_PUBLISHABLE_KEY);
        await stripe.redirectToCheckout({ sessionId: data.sessionId });
      } catch (err) {
        console.error("[TGK] Upgrade error:", err);
        alert("Could not start checkout: " + err.message);
      }
    });
  }

  // ðŸœ‚ Manage Billing Portal
  const manageBtn = document.getElementById("manage-btn");
  if (manageBtn) {
    manageBtn.addEventListener("click", async () => {
      const user = auth2.currentUser;
      if (!user) return alert("Please sign in to manage billing.");
      const token = await user.getIdToken();
      const res = await fetch("/.netlify/functions/create-portal-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, email: user.email })
      });
      const data = await res.json();
      if (res.ok && data.url) window.location.href = data.url;
      else alert("Could not open billing portal.");
    });
  }
</script>

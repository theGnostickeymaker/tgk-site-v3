{# ===========================================================
   âš¯ TGK â€” Synergist Lens (Global View) v2.3
   Purpose:
   Displays interconnections between the current page and
   other content types (pages, vault texts, threads, products)
   by reading from `/src/_data/synergyMap.json`.

   ðŸ”¹ Data Structure Expected:
     synergyMap = {
       nodes: [
         { id: "page001", title: "Gnostic Christianity", url: "/pillars/â€¦", pillar: "the-teachings" },
         { id: "vault003", title: "Apocryphon of John", url: "/pillars/the-vault/â€¦", pillar: "the-vault" },
         â€¦
       ],
       edges: [
         { source: "page001", target: "vault003", relation: "vaultRef" },
         { source: "page001", target: "page002", relation: "crossLink" }
       ]
     }

   ðŸ”¹ Front Matter Required:
     - pageId: unique ID for current page (must match node.id)

   ðŸ”¹ Relation Key:
     vaultRef  â†’ Vault
     crossLink â†’ page
     community â†’ Community
     product   â†’ Artifact

   ðŸ§­ Behaviour:
   - Finds all edges where source == current pageId
   - Displays each related node as a symbolic card
   - Applies relation-based class for accent styling

   ðŸœ‚ To-Do:
   Integrate D3.js / Cytoscape for dynamic visual mode later.
   =========================================================== #}

{% if synergyMap and pageId %}
<section id="synergist-lens-global" class="section-block synergist-lens-global">
  <h2 class="section-heading">âš¯ The Synergist Lens â€” Global View</h2>
  <p class="section-subtitle">
    Interconnections across all pillars of <strong>The Gnostic Key</strong>.
  </p>

  {# --- Filter edges for current page --- #}
  {% set edges = synergyMap.edges | filter(e => e.source == pageId) %}

  {% if edges and edges.length %}
    <div class="lens-global-grid">
      {% for edge in edges %}
        {% set target = synergyMap.nodes | find(n => n.id == edge.target) %}
        {% if target %}
          <article class="lens-global-card relation-{{ edge.relation }}">
            <header>
              <h3 class="lens-global-title">
                <a href="{{ target.url | safe }}" class="lens-link">{{ target.title }}</a>
              </h3>
            </header>

            <p class="lens-global-meta">
              <span class="lens-pill">
                {{ target.pillar | replace('the-', '') | capitalize }}
              </span>
              <span class="lens-type">
                {{ edge.relation
                  | replace('vaultRef', 'Vault')
                  | replace('crossLink', 'page')
                  | replace('community', 'Community')
                  | replace('product', 'Artifact') }}
              </span>
            </p>
          </article>
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <p class="lens-empty">
      No global connections found yet.<br>
      Add <code>crossLinks</code>, <code>vaultRefs</code>, or other arrays in your
      <strong>index.11tydata.js</strong> to populate this view.
    </p>
  {% endif %}
</section>
{% endif %}

{# ============================================================
   TGK â€” Community Topic Template (v2.0 FIXED)
   Fix: thread-list moved inside #discussion-root so replies nest properly
============================================================ #}

{% extends "base.njk" %}

{% block content %}
<main class="main-content">

  {# Floating navigation (Discussion, Add Reply, Share) #}
  {% include "partials/page-tabs-community.njk" %}

  <section class="content-container">

    <!-- INTRODUCTION -->
    <section id="topic-intro" class="section-block">
      <h1 class="section-heading">
        {{ title or ("Topic: " + topicId | labelize) }}
      </h1>

      {% if description %}
        <p class="lead">{{ description }}</p>
      {% endif %}
    </section>


    <!-- PARTICIPATION RULES -->
    <section id="guidance" class="section-block">
      <h2 class="section-heading">How to Participate</h2>

      <ul class="rules-list">
        <li>Begin every reply with a Steel Man summary.</li>
        <li>Engage ideas, not individuals.</li>
        <li>Clarify before criticising.</li>
        <li>Protect clarity and intellectual honesty.</li>
      </ul>

      <p class="muted small">
        Full guidelines:
        <a href="/pillars/tgk-community/guide/charter/" class="link-accent">
          TGK Community Charter
        </a>.
      </p>
    </section>


    <!-- =======================================================
         DISCUSSION ROOT (form + nested thread tree)
         NESTING ONLY WORKS WHEN THREAD LIST IS INSIDE THIS BLOCK
       ======================================================= -->
    <section id="discussion-root" class="section-block"
      data-topic-id="{{ topicId }}"
      data-min-write-tier="{{ minWriteTier }}">

      <!-- ADD NEW REPLY FORM -->
      {% include "components/discussion/reply-prompt.njk" %}

      <!-- FULL THREAD LIST (must be inside this section!) -->
      {% include "components/discussion/thread-list.njk" %}

    </section>


    <!-- SHARE BLOCK -->
    <section id="share" class="section-block">
      <h2 class="section-heading">Share this Discussion</h2>

      <div class="btn-row">
        <a class="btn"
          href="https://x.com/intent/tweet?text={{ title | urlencode }}&url={{ page.url | absoluteUrl | urlencode }}"
          target="_blank" rel="noopener">
          Share on X (Twitter)
        </a>

        <a class="btn"
          href="https://t.me/share/url?url={{ page.url | absoluteUrl | urlencode }}&text={{ title | urlencode }}"
          target="_blank" rel="noopener">
          Share on Telegram
        </a>
      </div>
    </section>

  </section>
</main>
{% endblock %}


{% block scripts %}
  {{ super() }}

  <!-- CORE AUTH AND USER LOADING -->
  <script type="module" src="/js/firebase-init.js"></script>
  <script type="module" src="/js/tgk-user.js"></script>

  <!-- COMMUNITY ENGINE -->
  <script type="module" src="/js/community-tabs.js"></script>
  <script type="module" src="/js/discussion-topic.js"></script>
  <script type="module" src="/js/community-delete.js"></script>
  <script type="module" src="/js/community-edit.js"></script>
{% endblock %}

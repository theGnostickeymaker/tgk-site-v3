---
layout: base.njk
title: "Your TGK Dashboard"
description: "Your personal TGK space, including bookmarks, progress, membership, and billing."
glyph: "ðŸœ‚"
glyphRow: ["ðŸœ‚", "â˜¥", "ðŸœ‚"]
bodyClass: "lightgold requires-auth"
permalink: "/dashboard/index.html"

# === Unified Header Hierarchy ===
siteTitle: "The Gnostic Key"
pillarTitle: "Membership"
gateTitle: "User Dashboard"
seriesTitle: null
seasonTitle: null
episodeTitle: "Dashboard"
partTitle: null

breadcrumbs:
  - { title: "The Gnostic Key", url: "/" }
  - { title: "Membership", url: "/membership/" }
  - { title: "Dashboard" }
---

{% block head %}
  {% set socialImage = "/tgk-assets/images/share/system/dashboard.jpg" %}
  {% include "partials/head-meta.njk" %}
  {% set headline = "Dashboard â€” The Gnostic Key" %}
  {% set base = "/dashboard/" %}
  {% include "partials/jsonld-collection.njk" %}
{% endblock %}

<main class="main-content dashboard">
  <section class="content-container" id="page-dashboard">

    <!-- Welcome Header -->
    <div class="dashboard-welcome">
      <h2 class="section-heading">
        Welcome, <span id="user-name" class="highlight">Seeker</span>
      </h2>
    </div>

    <!-- Current Tier Summary -->
    <div class="tier-display inline">
      <span>Your current tier:</span>
      <span id="tier-badge" class="tier-badge tier-free">Free</span>
      <span class="member-since muted"><span id="member-since">â€”</span></span>
    </div>

    <!-- Resume Reading (auto-shown only if a last page exists) -->
    <section class="section-block" id="resume-block" style="display:none;">
      <h3 class="section-heading">Continue your journey</h3>
      <p class="lead muted" id="resume-text">
        Pick up where you last left off.
      </p>
      <div class="btn-wrap">
        <a id="resume-link" href="#" class="btn outline">Resume Reading</a>
      </div>
    </section>

    <!-- Membership Management -->
    <section class="section-block">
      <h3 class="section-heading">Membership and Billing</h3>
      <div class="btn-wrap">
        <a href="/membership/" class="btn outline">View or Manage Membership</a>
      </div>
      <p class="small muted">
        Upgrade, join, or manage your billing at any time through your membership centre.
      </p>
    </section>

    <!-- Profile Information -->
    <section class="section-block auth-form">
      <h2 class="section-heading">Profile Information</h2>
      <p class="lead muted">Update your display name or review your account details below.</p>

      <form id="profile-form" class="tgk-form" autocomplete="off" novalidate>
        <div class="form-group">
          <label for="profile-name">Display Name</label>
          <input type="text" id="profile-name" placeholder="Your display name" required>
        </div>

        <div class="form-group">
          <label for="profile-email">Email Address</label>
          <input type="email" id="profile-email" disabled>
        </div>

        <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input
            type="checkbox"
            id="profile-email-optin"
            name="emailOptIn">
          <span>
            Receive updates, new scroll releases, and announcements from The Gnostic Key.
          </span>
        </label>
      </div>

      <p class="small muted privacy-note">
        We only use your email for essential account messages and, if you opt in, occasional updates from The Gnostic Key.
        You can change this preference at any time. We do not sell or share your data.
      </p>

        <div class="btn-wrap center">
          <button type="submit" class="btn outline full-width">Save Changes</button>
          <span id="profile-status" class="small muted"></span>
        </div>
      </form>
    </section>

    <!-- Activity Widgets (placeholder) -->
    <section hidden>
      <h3 class="section-heading">Your Activity</h3>
      <div class="dashboard-widgets">
        <div id="widget-quiz-progress" class="widget-slot"></div>
        <div id="widget-community-feed" class="widget-slot"></div>
        <div id="widget-key-balance" class="widget-slot"></div>
      </div>
    </section>

    <!-- Bookmarks -->
    <section class="section-block">
      <h3 class="section-heading">Your Bookmarks</h3>

      <div id="bookmark-dashboard">
        <p id="bookmark-loading" class="muted small">Loading bookmarks...</p>

        <div id="bookmark-grid-mount"></div>

        <p id="no-bookmarks" class="muted small" hidden>
          No bookmarks yet. Explore the
          <a href="/pillars/the-teachings/">Teachings</a> or the
          <a href="/pillars/the-vault/">Vault</a> to begin your journey.
        </p>
      </div>
    </section>

    <!-- Logout -->
    <section class="section-block">
      <h3 class="section-heading">Sign Out</h3>
      <p class="small">You may securely sign out of your TGK account below.</p>

      <div class="btn-wrap center">
        <button id="logout-btn" class="btn outline">Sign Out</button>
      </div>
    </section>

  </section>

  <div class="gnostic-divider">
    <span class="divider-symbol pillar-glyph spin glow" aria-hidden="true">{{ glyph }}</span>
  </div>
</main>

<!-- Dashboard Logic -->
<script type="module">
  import {
    loadDashboardHeader,
    refreshEntitlementsLive,
    pageSignout,
    saveProfile,
    updateTierUI
  } from "/js/tgk-user.js";

  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const auth = getAuth();

  document.addEventListener("DOMContentLoaded", () => {
    const cachedTier = localStorage.getItem("tgk-tier");
    if (cachedTier) updateTierUI(cachedTier);
    loadResumeCard();
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.__TGK_GATE__?.saveReturnUrl?.();
      return window.location.replace("/signin/");
    }

    await refreshEntitlementsLive(user);
    await loadDashboardHeader(user);

    document.getElementById("profile-form").addEventListener("submit", saveProfile);
    document.getElementById("logout-btn").addEventListener("click", pageSignout);
  });

  /* ===========================================================
     ðŸœ‚ Resume Reading â€” Dashboard Loader
     =========================================================== */
  function loadResumeCard() {
    const resumeUrl = localStorage.getItem("tgk-last-page");
    const block = document.getElementById("resume-block");
    const link = document.getElementById("resume-link");

    if (!resumeUrl || !block || !link) return;

    block.style.display = "block";
    link.href = resumeUrl;
  }
</script>

<script type="module" src="/js/bookmarks.js?v={{ bust }}"></script>
<script type="module" src="/js/tgk-auth.js?v={{ bust }}" defer></script>

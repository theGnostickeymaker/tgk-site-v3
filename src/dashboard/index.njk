---
layout: base.njk
title: "Your TGK Dashboard"
description: "Your personal TGK space â€” access bookmarks, progress, membership, and billing."
glyph: "ðŸœ‚"
glyphRow: ["ðŸœ‚", "â˜¥", "ðŸœ‚"]
bodyClass: "lightgold requires-auth"
permalink: "/dashboard/index.html"

breadcrumbs:
  - { title: "The Gnostic Key", url: "/" }
  - { title: "Dashboard" }
---
{% block head %}
  {% set socialImage = "/tgk-assets/images/share/system/dashboard.jpg" %}
  {% include "partials/head-meta.njk" %}
  {% set headline = "Dashboard â€” The Gnostic Key" %}
  {% set base = "/dashboard/" %}
  {% include "partials/jsonld-collection.njk" %}
{% endblock %}

<body>
<main class="main-content page-dashboard">
  <section class="content-container" id="page-dashboard">

    <!-- âœ¦ Welcome + Tier -->
    <h2 class="section-heading">Welcome, <span id="user-name">Seeker</span></h2>
    <p>Your current tier: <strong id="user-tier">Loadingâ€¦</strong></p>
    <span id="tier-badge" class="tier-badge tier-free">Free</span>

    <!-- âœ¦ Membership Management -->
    <div class="dashboard-membership">
      <h3 class="section-heading">Membership & Billing</h3>
      <div class="btn-wrap">
        <button id="upgrade-btn" class="btn gold">Upgrade / Join via Stripe</button>
        <button id="billing-btn" class="btn outline">Manage Billing Portal</button>
      </div>
      <p class="small">You can upgrade, downgrade, or cancel your plan at any time.</p>
    </div>

    <!-- âœ¦ Profile Information -->
    <h3 class="section-heading">Profile Information</h3>
    <form id="profile-form" class="form-block">
      <label for="profile-name">Display Name</label>
      <input type="text" id="profile-name" placeholder="Your name" />

      <label for="profile-email">Email</label>
      <input type="email" id="profile-email" placeholder="Your email" disabled />

      <div class="btn-wrap">
        <button type="submit" class="btn outline">Save Changes</button>
        <span id="profile-status" class="small muted"></span>
      </div>
    </form>

    <!-- âœ¦ Activity Widgets (optional hidden) -->
    <section hidden>
      <h3 class="section-heading">Your Activity</h3>
      <div class="dashboard-widgets">
        <div id="widget-quiz-progress" class="widget-slot"></div>
        <div id="widget-community-feed" class="widget-slot"></div>
        <div id="widget-key-balance" class="widget-slot"></div>
      </div>
    </section>

    <!-- âœ¦ Bookmarks -->
    <h3 class="section-heading">Your Bookmarks</h3>
    <div id="bookmark-dashboard">
      <p id="bookmark-loading" class="muted small">Loading bookmarksâ€¦</p>
      <div id="bookmark-grid-mount"></div>
      <p id="no-bookmarks" class="muted small" hidden>
        No bookmarks yet. Explore the <a href="/pillars/the-teachings/">Teachings</a> or
        the <a href="/pillars/the-vault/">Vault</a> to begin your journey.
      </p>
    </div>

    <!-- âœ¦ Logout -->
    <h3 class="section-heading">Sign Out</h3>
    <p class="small">You can securely sign out of your TGK account below.</p>
    <button id="logout-btn" class="btn outline">Sign Out</button>

  </section>

  <div class="gnostic-divider">
    <span class="divider-symbol pillar-glyph spin glow" aria-hidden="true">{{ glyph }}</span>
  </div>
</main>

<!-- ðŸœ‚ Dashboard Logic -->
<script type="module">
  import {
    loadDashboardHeader,
    refreshEntitlementsLive,
    pageSignout,
    saveProfile
  } from "/js/tgk-user.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const auth = getAuth();

  document.addEventListener("DOMContentLoaded", () => {
    const cachedTier = localStorage.getItem("tgk-tier");
    if (cachedTier) updateTierUI(cachedTier);
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.__TGK_GATE__?.saveReturnUrl?.();
      return window.location.replace("/signin/");
    }

    // ðŸ”¹ Always refresh live entitlements
    await refreshEntitlementsLive(user);
    await loadDashboardHeader(user);

    // ðŸ”¹ Bind actions
    document.getElementById("profile-form").addEventListener("submit", saveProfile);
    document.getElementById("logout-btn").addEventListener("click", pageSignout);
    document.getElementById("upgrade-btn").addEventListener("click", async () => {
      const token = await user.getIdToken();
      const res = await fetch("/.netlify/functions/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, uid: user.uid, email: user.email })
      });
      const data = await res.json();
      if (data.url) window.location.href = data.url;
      else alert("Could not start checkout. Please try again.");
    });
    document.getElementById("billing-btn").addEventListener("click", async () => {
      const token = await user.getIdToken();
      const res = await fetch("/.netlify/functions/create-portal-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, email: user.email })
      });
      const data = await res.json();
      if (data.url) window.location.href = data.url;
      else alert("Could not open billing portal.");
    });
  });
</script>

<script type="module" src="/js/bookmarks.js?v={{ bust }}"></script>
</body>

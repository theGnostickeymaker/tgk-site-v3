---
layout: base.njk
title: "Your TGK Dashboard"
description: "Your personal TGK space for membership, activity, bookmarks, and community participation."
glyph: "üúÇ"
glyphRow: ["üúÇ", "‚ò•", "üúÇ"]
bodyClass: "lightgold requires-auth"
permalink: "/dashboard/index.html"

# === Unified Header Hierarchy ===
siteTitle: "The Gnostic Key"
pillarTitle: "Membership"
gateTitle: "User Dashboard"
seriesTitle: null
seasonTitle: null
episodeTitle: "Dashboard"
partTitle: null

breadcrumbs:
  - { title: "The Gnostic Key", url: "/" }
  - { title: "Membership", url: "/membership/" }
  - { title: "Dashboard" }
---

{% block head %}
  {% set socialImage = "/tgk-assets/images/share/system/dashboard.jpg" %}
  {% include "partials/head-meta.njk" %}
  {% set headline = "User Dashboard ‚Äî The Gnostic Key" %}
  {% set base = "/dashboard/" %}
  {% include "partials/jsonld-collection.njk" %}
{% endblock %}

<main class="main-content dashboard">
  <section class="content-container" id="page-dashboard">

    <!-- Welcome -->
    <div class="dashboard-welcome">
      <h2 class="section-heading">
        Welcome, <span id="user-name" class="highlight">Seeker</span>
      </h2>
    </div>

    <!-- Membership Tier -->
    <div class="tier-display inline">
      <span>Your current membership:</span>
      <span id="tier-badge" class="tier-badge tier-free">Free</span>
      <span class="member-since muted">
        <span id="member-since">‚Äî</span>
      </span>
    </div>

    <!-- Jury Console -->
    <section class="section-block" id="jury-console">
      <h3 class="section-heading">Community Jury</h3>

      <p class="lead muted">
        You have been selected to take part in one or more community jury cases.
        Your role is to review the matter presented and cast a considered vote.
      </p>

      <div id="jury-cases">
        <p class="muted small">Loading assigned cases‚Ä¶</p>
      </div>
    </section>

    <!-- Resume Reading -->
    <section class="section-block" id="resume-block" style="display:none;">
      <h3 class="section-heading">Continue Reading</h3>
      <p class="lead muted" id="resume-text">
        Resume where you last left off.
      </p>
      <div class="btn-wrap">
        <a id="resume-link" href="#" class="btn outline">Resume</a>
      </div>
    </section>

    <!-- Membership Management -->
    <section class="section-block">
      <h3 class="section-heading">Membership and Billing</h3>
      <div class="btn-wrap">
        <a href="/membership/" class="btn outline">
          View or manage membership
        </a>
      </div>
      <p class="small muted">
        You may upgrade, downgrade, or review billing details at any time via the membership centre.
      </p>
    </section>

    <!-- Profile -->
    <section class="section-block auth-form">
      <h2 class="section-heading">Profile Details</h2>
      <p class="lead muted">
        Review or update your display name and communication preferences.
      </p>

      <form id="profile-form" class="tgk-form" autocomplete="off" novalidate>
        <div class="form-group">
          <label for="profile-name">Display name</label>
          <input
            type="text"
            id="profile-name"
            placeholder="Your display name"
            required>
        </div>

        <div class="form-group">
          <label for="profile-email">Email address</label>
          <input
            type="email"
            id="profile-email"
            disabled>
        </div>

        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              id="profile-email-optin"
              name="emailOptIn">
            <span>
              Receive updates, new releases, and announcements from The Gnostic Key.
            </span>
          </label>
        </div>

        <p class="small muted privacy-note">
          Your email is used only for essential account communication and optional updates if you opt in.
          We do not sell or share personal data.
        </p>

        <div class="btn-wrap center">
          <button type="submit" class="btn outline full-width">
            Save changes
          </button>
          <span id="profile-status" class="small muted"></span>
        </div>
      </form>
    </section>

    <!-- Bookmarks -->
    <section class="section-block">
      <h3 class="section-heading">Saved Bookmarks</h3>

      <div id="bookmark-dashboard">
        <p id="bookmark-loading" class="muted small">
          Loading bookmarks‚Ä¶
        </p>

        <div id="bookmark-grid-mount"></div>

        <p id="no-bookmarks" class="muted small" hidden>
          You have not saved any bookmarks yet.
          Explore the
          <a href="/pillars/the-teachings/">Teachings</a>
          or the
          <a href="/pillars/the-vault/">Vault</a>
          to begin.
        </p>
      </div>
    </section>

    <!-- Sign Out -->
    <section class="section-block">
      <h3 class="section-heading">Sign out</h3>
      <p class="small">
        Sign out securely from your TGK account.
      </p>

      <div class="btn-wrap center">
        <button id="logout-btn" class="btn outline">
          Sign out
        </button>
      </div>
    </section>

  </section>

  <div class="gnostic-divider">
    <span
      class="divider-symbol pillar-glyph spin glow"
      aria-hidden="true">
      {{ glyph }}
    </span>
  </div>
</main>

<!-- Dashboard Logic -->
<script type="module">
  import {
    loadDashboardHeader,
    refreshEntitlementsLive,
    pageSignout,
    saveProfile,
    updateTierUI
  } from "/js/tgk-user.js?v={{ bust }}";

  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  import { loadJuryConsole } from "/js/dashboard-jury.js?v={{ bust }}";
  
  const auth = getAuth();

  document.addEventListener("DOMContentLoaded", () => {
    const cachedTier = localStorage.getItem("tgk-tier");
    if (cachedTier) updateTierUI(cachedTier);
    loadResumeCard();
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.__TGK_GATE__?.saveReturnUrl?.();
      return window.location.replace("/signin/");
    }
    await loadJuryConsole(user);
    
    await refreshEntitlementsLive(user);
    await loadDashboardHeader(user);
    await loadJuryConsole(user); // ‚Üê THIS LINE MUST EXIST

    document
      .getElementById("profile-form")
      .addEventListener("submit", saveProfile);

    document
      .getElementById("logout-btn")
      .addEventListener("click", pageSignout);
  });

  function loadResumeCard() {
    const resumeUrl = localStorage.getItem("tgk-last-page");
    const block = document.getElementById("resume-block");
    const link = document.getElementById("resume-link");

    if (!resumeUrl || !block || !link) return;

    block.style.display = "block";
    link.href = resumeUrl;
  }
</script>

<script type="module" src="/js/bookmarks.js?v={{ bust }}"></script>
<script type="module" src="/js/tgk-auth.js?v={{ bust }}" defer></script>
